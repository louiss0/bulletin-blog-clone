---
import Container from "@/components/Container.astro";
import MainLayout from "@/components/MainLayout.astro";
import PostCard from "@/components/PostCard.astro";
import SubscriptionForm from "@/components/SubscriptionForm.astro";
import Post from "@/types/Post";

const { posts } = (await fetch(
  new URL("/src/mock-data/posts.json", Astro.url)
).then((response) => response.json())) as { posts: Array<Post> };

const subtractPrevPostDateTimestampFromNextPostDateTimestamp = (
  prevPost: Post,
  nextPost: Post
) =>
  new Date(nextPost.pubDate).getTime() - new Date(prevPost.pubDate).getTime();

const latestPosts = [...posts].sort(
  subtractPrevPostDateTimestampFromNextPostDateTimestamp
);

const latestFourPosts = latestPosts.slice(0, 4);

const tenRandomPosts = posts.slice(0, 10).reduceRight((acc, _, i, array) => {
  let j = Math.floor(Math.random() * (i + 1));

  const firstItem = array[i]!;
  const secondItem = array[j]!;

  acc[i] = firstItem;
  acc[j] = secondItem;

  return acc;
}, [] as typeof posts);

const postTags: Array<string> = [];

const [firstFeaturedPost, ...restofTheFeaturedPosts] = posts.filter((post) => {
  if (!postTags.includes(post.tag)) {
    postTags.push(post.tag);

    return post;
  }
  return;
});
---

<MainLayout title="Home">
  <Fragment slot="header">
    <SubscriptionForm
      title="A blog that people will actually want to read"
      content="People use Bulletin to share big ideas with the world on a regular basis with a focus on accessibility and usability."
      buttonText="Try it"
    />
  </Fragment>
  <Fragment slot="main">
    <section class="grid gap-2 px-4 py-6" aria-label="featured-posts">
      <Container>
        <div class:list={["grid gap-2", "lg:grid-cols-2 lg:gap-12"]}>
          {
            (() => {
              if (firstFeaturedPost) {
                return (
                  <PostCard
                    class="h-full"
                    headerClass={"rounded-md lg:h-3/5"}
                    footerClass={"lg:gap-16"}
                    title={firstFeaturedPost.title}
                    author={firstFeaturedPost.author}
                    image={firstFeaturedPost.image}
                    thumbnail={firstFeaturedPost.thumbnail}
                    pubDate={firstFeaturedPost.pubDate}
                    tag={firstFeaturedPost.tag}
                  />
                );
              }
            })()
          }
          <div class="grid gap-6">
            <h2 id="featured-posts">Featured Posts</h2>
            <ul class="grid gap-4 divide-y-2 divide-gray-400">
              {
                (function* () {
                  if (restofTheFeaturedPosts.length === 0) return;
                  for (const featuredPost of restofTheFeaturedPosts) {
                    yield (
                      <li class="py-4">
                        <PostCard
                          class={"flex flex-row-reverse"}
                          headerClass={"rounded-xl basis-2/5"}
                          title={featuredPost.title}
                          author={featuredPost.author}
                          image={featuredPost.image}
                          thumbnail={featuredPost.thumbnail}
                          pubDate={featuredPost.pubDate}
                          tag={featuredPost.tag}
                          footerClass={"basis-3/5"}
                        />
                      </li>
                    );
                  }
                })()
              }
            </ul>
          </div>
        </div>
      </Container>
    </section>

    <section class="px-6 py-8" aria-labelledby="latest-posts ">
      <Container maxWidthClass={"max-w-screen-xl"}>
        <div class="grid gap-6">
          <h2 id="latest-posts">Latest Posts</h2>
          <ul class="grid gap-4 lg:flex">
            {
              (function* () {
                if (latestFourPosts.length === 0) return;
                for (const latestPost of latestFourPosts) {
                  yield (
                    <li class="flex-1">
                      <PostCard
                        class={"h-full"}
                        headerClass={"rounded-2xl"}
                        footerClass={"px-2 py-4"}
                        title={latestPost.title}
                        image={latestPost.image}
                        thumbnail={latestPost.thumbnail}
                        author={latestPost.author}
                        pubDate={latestPost.pubDate}
                        tag={latestPost.tag}
                        title={latestPost.title}
                        footerClass={"w-full"}
                      />
                    </li>
                  );
                }
              })()
            }
          </ul>
        </div>
      </Container>
    </section>

    <section class="grid gap-4 px-4 py-6" aria-labelledby="more-posts">
      <Container>
        <div class="grid gap-12">
          <h2 id="more-posts">More Posts</h2>
          <ul class="grid gap-4 lg:grid-cols-2 lg:grid-rows-5">
            {
              (function* () {
                if (tenRandomPosts.length === 0) return;
                for (const randomPost of tenRandomPosts) {
                  yield (
                    <li>
                      <PostCard
                        class={"lg:flex gap-4"}
                        headerClass={"rounded-2xl basis-2/5"}
                        title={randomPost.title}
                        image={randomPost.image}
                        thumbnail={randomPost.thumbnail}
                        author={randomPost.author}
                        pubDate={randomPost.pubDate}
                        tag={randomPost.tag}
                        title={randomPost.title}
                        footerClass={"basis-3/5"}
                      />
                    </li>
                  );
                }
              })()
            }
          </ul>
        </div>
      </Container>
    </section>
  </Fragment>
</MainLayout>
